<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-dropdown/iron-dropdown.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../paper-material/paper-material.html">

<link rel="import" href="zdkelt-time-picker.html">
<script src="../moment/min/moment-with-locales.min.js"></script>

<dom-module id="zdkelt-input-time">
	<template>
		<style>
			:host {
				display: inline-block;
				@apply(--paper-font-body1);
			}

			.dropdown-content {
				background: white;
			}

			.buttons {
				text-align: right;
			}

			.dropdown-content {
				border: 1px solid lightgray;
				margin-top: 35px;
				@apply(--shadow-elevation-2dp);
			}
		</style>
		<div class="layout horizontal" id="inputTime">
			<paper-input class="flex" no-label-float value="{{value}}" on-tap="showTime"></paper-input>
			<paper-icon-button icon="schedule" on-tap="showTime"></paper-icon-button>
			<iron-dropdown horizontalAlign="left" verticalAlign="top" id="dropdown" on-iron-overlay-opened='_refresh'>
				<div class="dropdown-content">
					<zdkelt-time-picker id="picker"></zdkelt-time-picker>
					<div class="buttons">
						<content></content>
					</div>
				</div>
			</iron-dropdown>
		</div>
	</template>
	<script>
		'use strict';

		/* global moment */

		function n2str(value, pad) {
			return Array(Math.max(pad - String(value).length + 1, 0)).join(0) + value;
		}

		Polymer({
			is: 'zdkelt-input-time',

			properties: {
				value: {
					type              : String,
					value             : null,
					reflectToAttribute: true,
					notify            : true,
					observer          : '_setNewValue'
				}
			},

			listeners: {
				'tap': '_onDialogClick'
			},

			_onDialogClick: function (event) {
				var target = event.target;
				while (target && target !== this) {
					if (target.hasAttribute) {
						if (target.hasAttribute('dropdown-dismiss')) {
							this.$.dropdown.close();
							break;
						} else if (target.hasAttribute('dropdown-confirm')) {
							this.value = this.$.picker.value;
							this.$.dropdown.close();
							this.fire('change', this.value);
							break;
						}
					}
					target = target.parentNode;
				}
			},

			_setNewValue: function (newValue) {
				if (newValue) {
					if (newValue.match(/^\d{2}:\d{2}$/)) {
						this.$.picker.value = newValue;
					} else if (moment(newValue).isValid()) {
						this.value = n2str(moment(newValue).hours(), 2) + ':' + n2str(moment(newValue).minutes(), 2);
						this.$.picker.value = this.value;
					}
				}
			},

			showTime: function () {
				this.$.dropdown.open();
				this.$.picker.value = this.value;
			},

			_refresh: function () {
				this.$.picker.refresh();
			}
		});
	</script>
</dom-module>
