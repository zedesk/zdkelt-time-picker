<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="./zdkelt-clock.html">

<!--
A time picker component

version : __2.0.0__

A time picker component 'Ã  la' material design

This is a complete rewrite of the version 1, that doesn't work on firefox.

> __Warning__ component does not yet support the meridiem hours, and is based only on 24-hour clock.

Example:

    <zdkelt-time-picker value="17:00"></zdkelt-time-picker>

![](hero-timer.png)

> __Warning__ component does not yet support the meridiem hours, and is based only on 24-hour clock.

@group zdk Elements
@demo demo/index.html
-->
<dom-module id="zdkelt-time-picker">
  <template>
    <style>
      :host {
        position: relative;
        box-sizing: border-box;
        width: 220px;
        height: 270px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .box {
        display: flex;
        flex-direction: column;
      }

      .hour {
        font-family: inherit;
        font-size: 40px !important;
        text-align: center;
        line-height: 50px !important;
        height: 50px;
        background: var(--default-primary-color, #3f51b5);
        color: var(--divider-color, #dbdbdb);
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .selected {
        color: var(--primary-background-color, #ffffff);
      }

      .container {
        width: auto;
        height: 230px;
        margin: 10px;
      }

      div.spacer {
        display: flex;
      }

      zdkelt-clock {
        margin: 10px;
      }

      #meridiem {
        font-size: 70%;
        padding-left: 10px;
        flex: 1;
        text-align: left;
      }

    </style>
    <div id="header" class="hour">
      <div id="hour" class="selected" on-tap="_toggleView">{{hours}}</div>
      <div>:</div>
      <div id="minute" on-tap="_toggleView">{{minutes}}</div>
      <template is="dom-if" if="{{hour12}}">
        <div id="meridiem">{{meridiem}}</div>
      </template>
    </div>
    <div class="box">
      <zdkelt-clock id="hours" value="{{_hours}}" on-change="_dispatchChange" on-update="_hoursUpdate"></zdkelt-clock>
      <zdkelt-clock id="minutes" minutes value="{{_minutes}}" on-change="_dispatchChange" on-update="_minutesUpdate"></zdkelt-clock>
    </div>
  </template>
  <script>
    class ZdkEltTimePicker extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() {
        return 'zdkelt-time-picker'
      }
      static get properties() {
        return {
          /**
           * The value formated as 'HH:MM'
           *
           * The time is given in 24-hours time
           */
          value: {
            type: String,
            value: '00:00',
            reflectToAttribute: true,
            notify: true,
            observer: '_valueChanged',
          },
          /**
           * Define the view
           *
           * available value are `hours` (default) or `minutes`
           */
          view: {
            type: String,
            value: 'hour',
            observer: '_setView',
          },
          /**
           * not yet implemented
           * Boolean flag indicates to draw our clock with 12 hours
           */
          hour12: {
            type: Boolean,
            value: false,
            notify: true,
          },
          /**
           * The hours value
           */
          hours: {
            type: String,
            value: '00',
          },
          /**
           * The minutes value
           */
          minutes: {
            type: String,
            value: '00',
          },

          _hours: {
            type: Number,
            value: 0,
          },
        }
      }

      connectedCallback() {
        super.connectedCallback()
        // this.refresh()
        Polymer.RenderStatus.afterNextRender(this, () => {
          this.$.minutes.hidden = true
        })
      }

      /**
       * Force the redraw of the clock
       */
      refresh() {
        this.view = 'minute'
        setTimeout(() => {
          this.view = 'hour'
        }, 0)
      }

      /**
       * set the view, depending of the `view`property
       */
      _setView() {
        this.$.hour.classList.remove('selected')
        this.$.minute.classList.remove('selected')
        switch (this.view) {
          case 'hour':
            this.$.hour.classList.toggle('selected')
            this.$.hours.value = parseInt(this.hours, 10)
            this.$.hours.hidden = false
            this.$.minutes.hidden = true
            break
          case 'minute':
            this.$.minute.classList.toggle('selected')
            this.$.minutes.value = parseInt(this.minutes, 10)
            this.$.hours.hidden = true
            this.$.minutes.hidden = false
            break
        }
      }

      /**
       * toggle the view
       */
      _toggleView(evt) {
        var select = this.$.header.querySelector('.selected')
        if (evt && evt.target === select) {
          return
        }
        this.view = select.id === 'hour' ? 'minute' : 'hour'
      }

      _valueChanged(newValue, oldValue) {
        if (newValue === oldValue) return
        if (!newValue) {
          this.value = this.hours + ':' + this.minutes
          return
        }
        var tmp = newValue.match(/(\d+):(\d+)/)
        if (tmp) {
          this.hours = tmp[1]
          this.minutes = tmp[2]
          this.$.hours.value = parseInt(tmp[1], 10)
          this.$.minutes.value = parseInt(tmp[2], 10)
        }
      }

      _hoursUpdate(evt) {
        this.hours = (evt.detail + '').padStart(2, '0')
      }

      _minutesUpdate(evt) {
        this.minutes = (evt.detail + '').padStart(2, '0')
      }

      _dispatchChange() {
        this.value = this.hours + ':' + this.minutes
        this.dispatchEvent(new CustomEvent('change', {detail: this.value}))
        this.view = this.view === 'hour' ? 'minute' : 'hour'
      }
    }

    window.customElements.define(ZdkEltTimePicker.is, ZdkEltTimePicker)
  </script>
</dom-module>
