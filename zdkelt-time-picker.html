<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="zdkelt-clock.html">

<!--
A time picker component

version : __2.0.0__

A time picker component 'Ã  la' material design

This is a complete rewrite of the version 1, that doesn't work on firefox.

> __Warning__ component does not yet support the meridiem hours, and is based only on 24-hour clock.

Example:

    <zdkelt-time-picker value="17:00"></zdkelt-time-picker>

![](hero-timer.png)

> __Warning__ component does not yet support the meridiem hours, and is based only on 24-hour clock.

@group zdk Elements
@demo
-->
<dom-module id="zdkelt-time-picker">
  <template>
    <style>
      :host {
        position: relative;
        box-sizing: border-box;
        width: 220px;
        height: 270px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .box {
        display: flex;
        flex-direction: column;
      }

      .hour {
        font-family: inherit;
        font-size: 40px !important;
        text-align: center;
        line-height: 50px !important;
        height: 50px;
        background: var(--default-primary-color, #3f51b5);
        color: var(--divider-color, #dbdbdb);
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .selected {
        color: var(--primary-background-color, #ffffff);
      }

      .container {
        width: auto;
        height: 230px;
        margin: 10px;
      }

      div.spacer {
        display: flex;
      }

      zdkelt-clock {
        margin: 10px;
      }

      #meridiem {
        font-size: 70%;
        padding-left: 10px;
        flex: 1;
        text-align: left;
      }

    </style>
    <div id="header" class="hour">
      <div class="spacer"></div>
      <div id="hours" class="selected" on-tap="_toggleView">{{hours}}</div>
      <div>:</div>
      <div id="minutes" on-tap="_toggleView">{{minutes}}</div>
      <template is="dom-if" if="{{hour12}}">
        <div id="meridiem">{{meridiem}}</div>
      </template>
      <template is="dom-if" if="{{!hour12}}">
        <div class="spacer"></div>
      </template>
  </div>
  <div class="box">
    <zdkelt-clock id="clock" value="{{_value}}" on-change="_clockChange" on-update="_clockUpdate"></zdkelt-clock>
  </div>
  </template>
  <script>
    class ZdkEltTimePicker extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() {
        return 'zdkelt-time-picker'
      }
      static get properties() {
        return {
          /**
           * The value formated as 'HH:MM'
           *
           * The time is given in 24-hours time
           */
          value: {
            type: String,
            value: '00:00',
            reflectToAttribute: true,
            notify: true,
            observer: '_valueChanged',
          },
          /**
           * Define the view
           *
           * available value are `hours` (default) or `minutes`
           */
          view: {
            type: String,
            value: 'hours',
            observer: '_setView',
          },
          /**
           * not yet implemented
           * Boolean flag indicates to draw our clock with 12 hours
           */
          hour12: {
            type: Boolean,
            value: false,
            notify: true,
          },
          /**
           * The hours value
           */
          hours: {
            type: String,
            value: '00',
          },
          /**
           * The minutes value
           */
          minutes: {
            type: String,
            value: '00',
          },
        }
      }

      connectedCallback() {
        super.connectedCallback()
        this.refresh()
      }

      /**
       * Force the redraw of the clock
       */
      refresh() {
        this.view = 'minutes'
        setTimeout(() => {
          this.view = 'hours'
        }, 0)
      }

      /**
       * set the view, depending of the `view`property
       */
      _setView() {
        this.$.hours.classList.remove('selected')
        this.$.minutes.classList.remove('selected')
        switch (this.view) {
          case 'hours':
            this.$.hours.classList.toggle('selected')
            this.$.clock.minutes = false
            this.$.clock.value = parseInt(this.hours, 10)
            break
          case 'minutes':
            this.$.minutes.classList.toggle('selected')
            this.$.clock.minutes = true
            this.$.clock.value = parseInt(this.minutes, 10)
            break
        }
      }

      /**
       * toggle the view
       */
      _toggleView(evt) {
        var select = this.$.header.querySelector('.selected')
        if (evt && evt.target === select) {
          return
        }
        this.view = select.id === 'hours' ? 'minutes' : 'hours'
      }

      _valueChanged(newValue) {
        if (!newValue) {
          this.value = this.hours + ':' + this.minutes
          return
        }
        var tmp = newValue.match(/(\d+):(\d+)/)
        if (tmp) {
          this.set('hours', tmp[1])
          this.set('minutes', tmp[2])
          if (this.$.clock.minutes) {
            this.$.clock.value = parseInt(tmp[2], 10)
          } else {
            this.$.clock.value = parseInt(tmp[1], 10)
          }
        }
      }

      /**
       * intercept the `change`event of the zdkelt-clock component.
       *
       * if the the view was the `hours` view, it's then automatically changed
       * to the `minutes` view.
       */
      _clockChange(evt) {
        console.log('clock change')
        evt.stopPropagation()
        if (this.view === 'hours') {
          debugger
          this._toggleView()
        }
        this.dispatchEvent(new CustomEvent('change', {detail: this.value}))
      }

      /**
       * The `update` event is emitted when the mouse is dragged
       *
       * @event update
       */
      _clockUpdate(evt) {
        console.log('clock update')
        evt.stopPropagation()
        var tmp = parseInt(evt.detail, 10)
        this.set(this.view, (tmp < 10 ? '0' : '') + tmp)
        this.value = this.hours + ':' + this.minutes
        this.dispatchEvent(new CustomEvent('update', {detail: this.value}))
      }
    }

    window.customElements.define(ZdkEltTimePicker.is, ZdkEltTimePicker)
  </script>
</dom-module>
